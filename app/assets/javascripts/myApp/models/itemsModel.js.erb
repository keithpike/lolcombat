/**
* myApp.models.items Module
*
* Description
*/
angular.module('models.items', [])
	.service('ItemsModel', function($http, $q){
		var model = this,
				URLS = {
					GET: "/v1/items"
				},
				items,
				currentItem;
		
		function extract(result) {
			return result.data.items;
		}

		function cacheItems(result) {
			items = extract(result);
			return items;
		}

    function showError() {
      debugger
      console.log("an error has occurred: ")
    }

    model.setCurrentItem = function(itemKey) {
    	return model.asyncGetItemByKey(itemKey).then(function(item){
    		currentItem = item;
    	});
    }


    function getItemImage(itemKey) {
    	return model.asyncGetItemByKey(itemKey).then(function(item){
    		return item.image.full;
    	});
    }
    
    function getItemImages() {
    	return model.getItems().then(function(items) {
    		var images = [];
    		_.each(items, function(item) {
    			return images.push(item.image.full);
    		});
    		return images;
    	});
    }



		model.getItems = function() {
			return (items) ? $q.when(items) : $http.get(URLS.GET).then(cacheItems, showError);
		}

		model.asyncGetItemByKey = function(itemKey) {
			return $q(function(resolve, reject){
				setTimeout(function() {
					function findItem(key) {
						// loop over items and return item that matches or nil
            return _.find(items, function(item) {
              return item.item_id == key;
            });
					}
					if(items) {
						resolve(findItem(itemKey)); 
					} else {
						model.getItems()
							.then(function() {
								resolve(findItem(itemKey));
							});
					}
				}, 0);
			});
		};

		model.getCurrentItem = function() {
    	return currentItem;
    };

    model.getCurrentItemImage = function() {
    	return currentItem ? currentItem.image.full : '';
    };

		model.getItemImages = function() {
			return getItemImages();
		};

		model.getItemImage = function(item) {
			return item ? item.image.full : '';
		};

		model.getItemSprite = function(item) {
			return item ? item.image.sprite : '';
		};

		model.getItemId = function(item) {
    	return item ? item.item_id : '';
    };

    model.getItemName = function(item) {
    	return item ? item.name : '';
    };

    model.getItemDescription = function(item) {
    	return item ? item.description : '';
    };

    model.getItemGoldCost = function(item) {
    	return item ? item.total_gold : '';
    };
	})
;